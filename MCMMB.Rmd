---
title: How do IUCN Range maps of birds compare to SDMs in Indonesian New Guinea? What
  are the main predictors for this distribution?
author: "Jonathan Gehret, Paul Leister"
date: "31.08.2021"
output:
  html_notebook:
    toc: yes
    code_folding: show
  html_document:
    toc: yes
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Introduction


# 2. Methods

To find the species to be used for our analysis we used the loops in bird_plot_loops.R to plot all species from the gbif and IUCN datasets to find birds with sufficient observation points and different ranges to be used for our project.

## 2.1. Main script

The required libraries and the setup of the IUCN and gbif data sets are done in the MCMMB_Main.R script. Notably, the HBIF data are created only for species with greater than 100 observations.The GBIF data were downloaded manually beforehand, however the r library "rgbif" could be used instead. Additionally, the island borders are read in and given the name "regio".

```{r, results='hide'}
source("MCMMB_Main.R")
```


## 2.2. Species data  

The script species_loops.R includes two functions each for creating lists with the input bird species data for gbif ("get_gbif_birds(bird_names,gbif_crop,regio)") and IUCN ("get_iucn_birds(bird_names,birdlife,regio)") and plotting them, respectively.

```{r}
# loading of the descriped functions
source("species_loops.R")

# cassowaries didn't have enough data
#bird_names = c("Casuarius bennetti", "Casuarius casuarius", "Casuarius unappendiculatus")

# we chose Pachycephala instead
bird_names = c("Pachycephala lorentzi", 
               "Pachycephala meyeri", 
               "Pachycephala schlegelii",
               "Pachycephala simplex",
               "Pachycephala soror")

# these names can be changed to any other bird species occuring in the data sets, for fully automated creation of sdms following this markdown file:
# bird_names = c(your_favorite_species_here)

# for plotting gbif data next to iucn data
par(mfrow = c(2,length(bird_names)))

# create list with birds out of the iucn and gbif data
iucn_birds = get_iucn_birds(bird_names,birdlife,regio)
gbif_birds = get_gbif_birds(bird_names,gbif_crop,regio)
```

## 2.3. Create presence-absence data

While biomod2 also brings with it capabilities to create pseudo-absence data, we built a script to do it. First centroids for the area were created, based on that an equal number to the presence data of absence points is created.

    "Be sure to take care when considering the use of pseudo-absences versus true absences for species distribution
    modeling. Similarly, it is extremely important to consider the influence of sampling bias in the data used to
    train models. Further reading: e.g., Guillera-Arroita et al. 2015, Kramer-Schadt et al. 2013, and Merow et al
    2013."
    

```{r}
# load presence_absence.R script including the function
source("presence_absence.R")
presence_absence_list = create_pseudo_absence(regio,gbif_birds)
```

## 2.4. Indicators

The Indicator.R script is used to read in data for the various indicators (precipitation, elevation, landcover, primary_forest, temperature, human population) to be used for the SDM. These are then cropped to the target region and saved in .tif format in the folder data/indicator_stack/ for later use. As the process for some of the bigger files takes a lot of time, ready to use indicator .tif files are to be found in the aforementioned folder. These will then be loaded and stacked later on before the sdm creation.

```{r, eval = FALSE}
# where all the predictors are loaded in
source("Indicator.R")
```

```{r}
# stacking all predictors found in folder indicator stack in .tif format
# predictors: elevation, precipitation, temperature, primary forest, landcover, population
tif_predictors = stack(list.files(path = "data/indicator_stack/",
                                full.names = TRUE,
                                pattern = ".tif"))
plot(tif_predictors)
```


## 2.5. Species distribution models

Using biomod2, the indicator stack, and the presence absence data with the gbif birds of interest the species distribution models with the methods GLM, GAM, RF and ANN are produced. There are also alternative methods available, which can be shown using "BIOMOD_ModelingOptions()". Each of the individual SDM versions can also be modified further, as can be seen in our script we modified k for the GAM (line 25). The dtaa set was not split in two for evaluation, however this step could be done next time.

```{r,results='hide'}
# loading biomod script and passing ensemble models to test_sdms
source("sdm_biomod2.R")
test_sdms = calculate_sdm(presence_absence_list, tif_predictors)
```

## 2.6. Comparison SDMs and IUCN

Plotting and comparing sdms with birdlife data.

```{r}
source("plotting_sdms.R")
#plot some nice plots here!
```


## 7.2 Code


MCMMB.Rmd

```{r, eval = FALSE, code = xfun::read_utf8("MCMMB.Rmd"), class.source = "fold-hide"}
```

MCMMB_Main.R

```{r, eval = FALSE, code = xfun::read_utf8("MCMMB_Main.R"), class.source = "fold-hide"}
```

species_loops.R

```{r, eval = FALSE, code = xfun::read_utf8("species_loops.R"), class.source = "fold-hide"}
```

presence_absence.R

```{r, eval = FALSE, code = xfun::read_utf8("presence_absence.R"), class.source = "fold-hide"}
```

Indicator.R

```{r, eval = FALSE, code = xfun::read_utf8("Indicator.R"), class.source = "fold-hide"}
```

sdm_biomod2.R

```{r, eval = FALSE, code = xfun::read_utf8("sdm_biomod2.R"), class.source = "fold-hide"}
```

plotting_sdms.R

```{r, eval = FALSE, code = xfun::read_utf8("plotting_sdms.R"), class.source = "fold-hide"}
```